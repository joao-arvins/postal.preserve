/**
 * postal.preserve - Add-on for postal.js that provides message durability features.
 * Author: Jim Cowart (http://freshbrewedcode.com/jimcowart)
 * Version: v0.2.0
 * Url: http://github.com/postaljs/postal.preserve
 * License(s): MIT
 */
(function(e,t){"function"==typeof define&&define.amd?define(["lodash","conduitjs","postal"],function(r,i,n){return t(r,i,n,e)}):"object"==typeof module&&module.exports?module.exports=function(e){t(require("lodash"),require("conduitjs"),e,this)}:e.postal=t(e._,e.Conduit,e.postal,e)})(this,function(e,t,r){function i(){for(var t=new Date,r=e.filter(n.expiring,function(e){return e.expires<t});r.length;)r.pop().purge()}{var n=r.preserve={store:{},expiring:[]},o=(r.channel(r.configuration.SYSTEM_CHANNEL),function(e,t){return t.expires-e.expires});r.addWireTap(function(t,r){var i=r.channel,s=r.topic;r.headers&&r.headers.preserve&&(n.store[i]=n.store[i]||{},n.store[i][s]=n.store[i][s]||[],n.store[i][s].push(r),r.headers.expires&&(n.expiring.push({expires:r.headers.expires,purge:function(){n.store[i][s]=e.without(n.store[i][s],r),n.expiring=e.without(n.expiring,this)}}),n.expiring.sort(o)))})}if(!r.subscribe.after){var s=r.subscribe;r.subscribe=new t.Sync({context:r,target:s})}return r.SubscriptionDefinition.prototype.enlistPreserved=function(){var t=this.channel,o=this.topic,s=this;return i(!0),n.store[t]&&e.each(n.store[t],function(t,i){r.configuration.resolver.compare(o,i)&&e.each(t,function(e){s.callback.call(s.context||s.callback.context&&s.callback.context()||this,e.data,e)})}),this},r});